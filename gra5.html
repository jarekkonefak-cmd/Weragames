<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gra 5: Nasze Gwiazdy</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky-dark: #050510;
            --star-color: #fcf6ba;
            --gold: #d4af37;
        }

        body {
            margin: 0;
            background: var(--sky-dark);
            color: white;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        h2 {
            font-family: 'Dancing Script', cursive;
            color: var(--star-color);
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 20px;
            pointer-events: none;
            text-shadow: 0 0 15px rgba(252, 246, 186, 0.5);
        }

        #canvas-container {
            position: relative;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        canvas {
            display: block;
            cursor: crosshair;
            border-radius: 20px;
        }

        .hint {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- FINALNY KOMUNIKAT --- */
        #final-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
        }

        #final-overlay.show { display: flex; animation: fadeIn 1s; }

        .btn-end {
            background: var(--gold);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 30px;
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
            text-decoration: none;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h2>Zapisz naszą historię w gwiazdach...</h2>

    <div id="canvas-container">
        <canvas id="skyCanvas"></canvas>
    </div>

    <p class="hint">Połącz pulsujące punkty w jedną całość</p>

    <div id="final-overlay">
        <h3 style="font-family: 'Dancing Script'; font-size: 3rem; color: var(--gold); margin: 0;">Zawsze Ty ❤️</h3>
        <p style="max-width: 300px; line-height: 1.6;">Każda gwiazda na niebie przypomina mi o Tobie. Ostatnie wspomnienie czeka w galerii.</p>
        <a href="index.html" class="btn-end" onclick="finish()">Odbierz obraz</a>
    </div>

    <script>
        const canvas = document.getElementById('skyCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = Math.min(window.innerWidth - 40, 360);
        canvas.height = 480;

        let stars = [
            {x: 180, y: 130, r: 5, active: false, target: 0}, // Góra środek
            {x: 100, y: 100, r: 5, active: false, target: 1}, // Lewy łuk
            {x: 50,  y: 180, r: 5, active: false, target: 2}, // Lewy bok
            {x: 180, y: 400, r: 5, active: false, target: 3}, // Dół
            {x: 310, y: 180, r: 5, active: false, target: 4}, // Prawy bok
            {x: 260, y: 100, r: 5, active: false, target: 5}  // Prawy łuk
        ];

        let particles = [];
        let connections = [];
        let isDrawing = false;
        let lastStar = null;
        let pulse = 0;

        function createParticle(x, y) {
            for(let i=0; i<2; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    life: 1,
                    size: Math.random() * 2
                });
            }
        }

        function draw() {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            pulse += 0.05;
            const sPulse = Math.sin(pulse) * 3;

            // Tło - pył gwiezdny
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            for(let i=0; i<30; i++) {
                ctx.beginPath();
                ctx.arc((i * 137) % canvas.width, (i * 243) % canvas.height, 0.8, 0, Math.PI*2);
                ctx.fill();
            }

            // Rysowanie połączeń
            ctx.lineWidth = 2;
            connections.forEach(conn => {
                ctx.strokeStyle = `rgba(252, 246, 186, 0.8)`;
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#fcf6ba';
                ctx.beginPath();
                ctx.moveTo(conn.from.x, conn.from.y);
                ctx.lineTo(conn.to.x, conn.to.y);
                ctx.stroke();
            });

            // Iskry za palcem
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.02;
                if(p.life <= 0) particles.splice(i, 1);
                ctx.fillStyle = `rgba(252, 246, 186, ${p.life})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
            });

            // Rysowanie gwiazd
            stars.forEach(s => {
                ctx.shadowBlur = s.active ? 20 + sPulse : 10;
                ctx.shadowColor = '#fcf6ba';
                ctx.fillStyle = s.active ? '#fcf6ba' : 'rgba(252, 246, 186, 0.3)';
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.active ? 6 : 4, 0, Math.PI*2);
                ctx.fill();
            });

            requestAnimationFrame(draw);
        }

        function handleInput(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

            if (isDrawing) createParticle(x, y);

            stars.forEach(s => {
                const dist = Math.hypot(s.x - x, s.y - y);
                if (dist < 25) {
                    if (!lastStar) {
                        s.active = true;
                        lastStar = s;
                        isDrawing = true;
                    } else if (s !== lastStar) {
                        // Sprawdzanie czy już jest takie połączenie
                        const exists = connections.some(c => (c.from === lastStar && c.to === s) || (c.from === s && c.to === lastStar));
                        if (!exists) {
                            connections.push({from: lastStar, to: s});
                            s.active = true;
                            lastStar = s;
                            if (connections.length === stars.length) {
                                // Dodajemy ostatnie połączenie do zamknięcia serca
                                connections.push({from: stars[stars.length-1], to: stars[0]});
                                win();
                            }
                        }
                    }
                }
            });
        }

        function win() {
            isDrawing = false;
            setTimeout(() => {
                document.getElementById('final-overlay').classList.add('show');
            }, 800);
        }

        function finish() {
            localStorage.setItem('wygrana5', 'tak');
        }

        canvas.addEventListener('mousedown', () => isDrawing = true);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); isDrawing = true; }, {passive: false});
        window.addEventListener('mousemove', handleInput);
        window.addEventListener('touchmove', handleInput, {passive: false});
        window.addEventListener('mouseup', () => { isDrawing = false; lastStar = null; });
        window.addEventListener('touchend', () => { isDrawing = false; lastStar = null; });

        draw();
    </script>
</body>
</html>
