<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gra 5: Nasza Konstelacja</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky-dark: #050510;
            --star-color: #fcf6ba;
            --gold: #d4af37;
        }

        body {
            margin: 0;
            background: var(--sky-dark);
            color: white;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none; /* Blokada scrolla */
        }

        h2 {
            font-family: 'Dancing Script', cursive;
            color: var(--star-color);
            font-size: 1.8rem;
            text-align: center;
            margin: 0 20px 20px;
            pointer-events: none;
            text-shadow: 0 0 15px rgba(252, 246, 186, 0.5);
        }

        #canvas-container {
            position: relative;
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.15);
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(0,0,0,0.3);
        }

        canvas {
            display: block;
            cursor: crosshair;
            border-radius: 20px;
        }

        .hint {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-align: center;
        }

        /* FINALNY KOMUNIKAT */
        #final-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.96);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            text-align: center;
            padding: 30px;
            box-sizing: border-box;
            color: #333;
        }

        #final-overlay.show { display: flex; animation: fadeIn 0.8s forwards; }

        .btn-end {
            background: linear-gradient(135deg, #d4af37, #b88a44);
            color: white;
            border: none;
            padding: 16px 45px;
            border-radius: 35px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 25px;
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h2>Połącz gwiazdy w odpowiedniej kolejności...</h2>

    <div id="canvas-container">
        <canvas id="skyCanvas"></canvas>
    </div>

    <p class="hint">Zacznij od migającej gwiazdy u góry</p>

    <div id="final-overlay">
        <h3 style="font-family: 'Dancing Script'; font-size: 2.8rem; color: var(--gold); margin: 0;">Nasze Niebo ❤️</h3>
        <p style="max-width: 280px; line-height: 1.6; font-size: 0.95rem;">Każdy punkt to chwila, którą z Tobą dzielę. Wszystkie wspomnienia są już Twoje.</p>
        <a href="index.html" class="btn-end" onclick="finish()">Wróć do Galerii</a>
    </div>

    <script>
        const canvas = document.getElementById('skyCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = Math.min(window.innerWidth - 40, 360);
        canvas.height = 460;

        // UKŁAD 12 GWIAZD (Serce) - Kolejność jest kluczowa!
        // id: 0 to start, musimy iść do 1, potem do 2 itd.
        let stars = [
            {x: 180, y: 130, id: 0}, // 0. Góra środek (START)
            {x: 130, y: 95,  id: 1}, // 1. Lewy łuk góra
            {x: 75,  y: 110, id: 2}, // 2. Lewy bok góra
            {x: 45,  y: 180, id: 3}, // 3. Lewy bok środek
            {x: 70,  y: 270, id: 4}, // 4. Lewy dół
            {x: 120, y: 350, id: 5}, // 5. Lewy dół przy cyplu
            {x: 180, y: 410, id: 6}, // 6. Dół (Cypel)
            {x: 240, y: 350, id: 7}, // 7. Prawy dół przy cyplu
            {x: 290, y: 270, id: 8}, // 8. Prawy dół
            {x: 315, y: 180, id: 9}, // 9. Prawy bok środek
            {x: 285, y: 110, id: 10},// 10. Prawy bok góra
            {x: 230, y: 95,  id: 11} // 11. Prawy łuk góra
        ];

        // LOGIKA GRY
        let nextTargetId = 1; // Szukamy gwiazdy nr 1 (bo zaczynamy od 0)
        let currentStar = stars[0]; // Aktualna pozycja "pióra" (zaczynamy od 0)
        let connections = []; // Zatwierdzone linie
        
        let isDragging = false;
        let dragX = 0;
        let dragY = 0;
        
        let particles = [];
        let pulse = 0;

        function createSparkle(x, y) {
            particles.push({
                x, y,
                vx: (Math.random() - 0.5) * 1.5,
                vy: (Math.random() - 0.5) * 1.5,
                life: 1.0,
                size: Math.random() * 2 + 0.5
            });
        }

        function draw() {
            // Czyszczenie i tło
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            pulse += 0.05;
            const glow = Math.sin(pulse) * 5;

            // 1. Rysowanie zatwierdzonych połączeń (Stałe linie)
            ctx.lineWidth = 3;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            
            connections.forEach(c => {
                ctx.strokeStyle = '#fcf6ba';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#fcf6ba';
                ctx.beginPath();
                ctx.moveTo(c.from.x, c.from.y);
                ctx.lineTo(c.to.x, c.to.y);
                ctx.stroke();
            });

            // 2. Rysowanie linii "gumki" (za palcem)
            if (isDragging) {
                ctx.strokeStyle = 'rgba(252, 246, 186, 0.5)';
                ctx.setLineDash([5, 5]); // Linia przerywana
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.moveTo(currentStar.x, currentStar.y);
                ctx.lineTo(dragX, dragY);
                ctx.stroke();
                ctx.setLineDash([]); // Reset linii
            }

            // 3. Rysowanie gwiazd
            stars.forEach(s => {
                // Gwiazda jest aktywna jeśli już ją połączyliśmy LUB jest naszym obecnym celem
                let isActive = (s.id < nextTargetId) || (s.id === 0);
                let isTarget = (s.id === nextTargetId);
                
                // Jeśli to cel, pulsuje mocniej
                let currentGlow = isTarget ? 15 + glow : (isActive ? 10 : 0);
                
                ctx.shadowBlur = currentGlow;
                ctx.shadowColor = '#fcf6ba';
                ctx.fillStyle = isActive || isTarget ? '#fcf6ba' : 'rgba(252, 246, 186, 0.2)';
                
                ctx.beginPath();
                ctx.arc(s.x, s.y, isActive ? 5 : 3, 0, Math.PI*2);
                ctx.fill();

                // Oznaczenie startu (tylko na początku)
                if (s.id === 0 && nextTargetId === 1) {
                    ctx.beginPath();
                    ctx.strokeStyle = `rgba(255,255,255, ${Math.abs(Math.sin(pulse))})`;
                    ctx.arc(s.x, s.y, 10 + glow/2, 0, Math.PI*2);
                    ctx.stroke();
                }
            });

            // 4. Cząsteczki
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.02;
                if(p.life <= 0) particles.splice(i, 1);
                ctx.fillStyle = `rgba(252, 246, 186, ${p.life})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
            });

            requestAnimationFrame(draw);
        }

        function handleInput(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            dragX = clientX - rect.left;
            dragY = clientY - rect.top;

            if (e.type === 'mousedown' || e.type === 'touchstart') {
                // Sprawdź czy kliknął blisko AKTUALNEJ gwiazdy, żeby zacząć rysować
                const dist = Math.hypot(currentStar.x - dragX, currentStar.y - dragY);
                if (dist < 40) {
                    isDragging = true;
                }
            }

            if (isDragging) {
                createSparkle(dragX, dragY);

                // Sprawdź kolizję z NASTĘPNĄ gwiazdą
                // Szukamy tylko gwiazdy o ID == nextTargetId
                // (lub ID == 0 jeśli jesteśmy na końcu - zamykanie pętli)
                
                let targetId = nextTargetId;
                if (nextTargetId === stars.length) targetId = 0; // Zamykanie serca

                const targetStar = stars[targetId];
                const dist = Math.hypot(targetStar.x - dragX, targetStar.y - dragY);

                if (dist < 25) {
                    // TRAFIENIE POPRAWNEJ GWIAZDY!
                    connections.push({from: currentStar, to: targetStar});
                    currentStar = targetStar;
                    
                    // Efekt sukcesu
                    for(let k=0; k<10; k++) createSparkle(targetStar.x, targetStar.y);

                    if (targetId === 0 && nextTargetId === stars.length) {
                        // KONIEC GRY (zamknęliśmy pętlę)
                        win();
                    } else {
                        nextTargetId++;
                    }
                }
            }
        }

        function stopDragging() {
            isDragging = false;
        }

        function win() {
            isDragging = false;
            // Dorysowanie ostatniej linii na stałe
            localStorage.setItem('wygrana5', 'tak');
            setTimeout(() => {
                document.getElementById('final-overlay').classList.add('show');
            }, 500);
        }

        function finish() {
            window.location.href = 'index.html';
        }

        // Event Listeners
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('mousemove', (e) => { if(isDragging) handleInput(e); });
        window.addEventListener('mouseup', stopDragging);

        canvas.addEventListener('touchstart', handleInput, {passive: false});
        canvas.addEventListener('touchmove', handleInput, {passive: false});
        window.addEventListener('touchend', stopDragging);

        draw();
    </script>
</body>
</html>
