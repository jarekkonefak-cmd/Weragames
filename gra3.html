<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gra 3: Flappy Heart</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fdfbf7;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            touch-action: none; /* Blokada przewijania na telefonie */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px; /* Ograniczenie szerokoci na du偶ych ekranach */
            background: linear-gradient(to bottom, #dbebf7, #fdfbf7);
            border-left: 2px solid #ddd;
            border-right: 2px solid #ddd;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI */
        .ui-layer {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        h2 {
            font-family: 'Dancing Script', cursive;
            color: #d4af37;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 1px 1px 0px white;
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 0 #d4af37;
            margin-top: 10px;
        }

        /* Ekrany (Start / Game Over / Win) */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden { display: none !important; }

        .btn {
            background: #d4af37;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            transition: transform 0.1s;
        }

        .btn:active { transform: scale(0.95); }

        .tutorial {
            margin-top: 20px;
            color: #777;
            font-size: 0.9rem;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }

    </style>
</head>
<body>

    <div id="game-container">
        <div class="ui-layer">
            <h2 id="level-title">Le do mnie!</h2>
            <div class="score-display" id="score">0</div>
        </div>

        <canvas id="canvas"></canvas>

        <div id="start-screen" class="screen">
            <h1 style="color: #d4af37; font-family: 'Dancing Script'; font-size: 3rem;">Flappy Heart</h1>
            <p style="color: #555;">Omi 10 zotych kolumn, aby wygra.</p>
            <div class="tutorial"> Tapnij, aby lecie</div>
            <button class="btn" onclick="startGame()">START</button>
        </div>

        <div id="fail-screen" class="screen hidden">
            <h1 style="color: #ff4d4d; font-family: 'Dancing Script'; font-size: 3rem;">Ups! </h1>
            <p style="color: #555;">Serduszko uderzyo. Spr贸buj jeszcze raz!</p>
            <button class="btn" style="background: #ff4d4d;" onclick="resetGame()">Pon贸w pr贸b</button>
        </div>

        <div id="win-screen" class="screen hidden">
            <h1 style="color: #d4af37; font-family: 'Dancing Script'; font-size: 3.5rem;">Udao si!</h1>
            <p style="color: #555;">Doleciaa bezpiecznie do celu.</p>
            <a href="index.html" class="btn" onclick="finish()">Odbierz obraz</a>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Elementy DOM
        const scoreEl = document.getElementById('score');
        const startScreen = document.getElementById('start-screen');
        const failScreen = document.getElementById('fail-screen');
        const winScreen = document.getElementById('win-screen');

        // Ustawienia gry
        let frames = 0;
        let score = 0;
        let gameSpeed = 3; // Prdko przesuwania
        let isRunning = false;
        const TARGET_SCORE = 10; // Ile punkt贸w do wygranej

        // Twarz (opcjonalnie)
        const faceImg = new Image();
        faceImg.src = 'twarz.png';

        // Skalowanie Canvas
        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- OBIEKT: GRACZ (SERCE) ---
        const bird = {
            x: 50,
            y: 150,
            w: 34,
            h: 28,
            radius: 14,
            velocity: 0,
            gravity: 0.25,
            jump: -5.5, // Sia skoku
            rotation: 0,

            draw: function() {
                ctx.save();
                ctx.translate(this.x, this.y);
                // Obr贸t w zale偶noci od prdkoci
                this.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
                ctx.rotate(this.rotation);

                // Cie
                ctx.shadowBlur = 10;
                ctx.shadowColor = "rgba(230, 0, 0, 0.3)";

                // Rysowanie serca
                ctx.fillStyle = '#e63946';
                ctx.beginPath();
                ctx.moveTo(0, 0);
                // Skalujemy ksztat serca
                const s = 1.2; 
                ctx.bezierCurveTo(-10*s, -10*s, -20*s, 5*s, 0, 20*s);
                ctx.bezierCurveTo(20*s, 5*s, 10*s, -10*s, 0, 0);
                ctx.fill();

                // Mae skrzydeko (animowane)
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                // Machanie skrzydem
                const wingY = (frames % 10 < 5) ? -5 : 0;
                ctx.ellipse(-5, -5 + wingY, 8, 4, -0.5, 0, Math.PI * 2);
                ctx.fill();

                // Twarz w rodku (jeli jest plik)
                if (faceImg.complete && faceImg.naturalWidth !== 0) {
                    ctx.clip(); // Przycinamy do ostatniego ksztatu (skrzyda nie przytnie bo to nowy path)
                    // Ale musimy przyci do serca... upromy:
                    // Rysujemy k贸ko w rodku serca z twarz
                    ctx.beginPath();
                    ctx.arc(0, 5, 8, 0, Math.PI*2);
                    ctx.clip();
                    ctx.drawImage(faceImg, -8, -3, 16, 16);
                }

                ctx.restore();
            },

            update: function() {
                this.velocity += this.gravity;
                this.y += this.velocity;

                // Podoga
                if (this.y + this.h/2 >= canvas.height) {
                    this.y = canvas.height - this.h/2;
                    gameOver();
                }
                // Sufit
                if (this.y - this.h/2 <= 0) {
                    this.y = this.h/2;
                    this.velocity = 0;
                }
            },

            flap: function() {
                this.velocity = this.jump;
            }
        };

        // --- OBIEKT: RURY (KOLUMNY) ---
        const pipes = {
            position: [],
            w: 50,
            h: 0, // dynamiczne
            gap: 160, // Odstp midzy g贸rn a doln rur (im wicej tym atwiej)
            dx: gameSpeed,

            draw: function() {
                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    let topY = p.y;
                    let bottomY = p.y + this.gap;

                    ctx.fillStyle = '#d4af37'; // Zoty kolor
                    
                    // G贸rna kolumna
                    // Trzon
                    ctx.fillRect(p.x, 0, this.w, topY);
                    // Ozdobna gowica (cap)
                    ctx.fillRect(p.x - 5, topY - 20, this.w + 10, 20);
                    // Cieniowanie (efekt 3D)
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(p.x + 5, 0, 10, topY); 

                    // Dolna kolumna
                    ctx.fillStyle = '#d4af37';
                    ctx.fillRect(p.x, bottomY, this.w, canvas.height - bottomY);
                    // Gowica
                    ctx.fillRect(p.x - 5, bottomY, this.w + 10, 20);
                    // Cieniowanie
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(p.x + 5, bottomY + 20, 10, canvas.height - bottomY);
                }
            },

            update: function() {
                // Dodawanie nowych rur co 120 klatek
                if (frames % 120 === 0) {
                    // Losowa pozycja dziury
                    // min Y = 50, max Y = canvas.height - gap - 50
                    let maxY = canvas.height - this.gap - 100;
                    let y = Math.floor(Math.random() * (maxY - 100)) + 100;
                    
                    this.position.push({
                        x: canvas.width,
                        y: y,
                        passed: false
                    });
                }

                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    p.x -= this.dx;

                    // Kolizje
                    // Czy ptak jest w poziomie rury?
                    if (bird.x + bird.radius > p.x && bird.x - bird.radius < p.x + this.w) {
                        // Czy ptak uderzy w g贸rn LUB doln?
                        // (bird.y - radius < topY) OR (bird.y + radius > bottomY)
                        if ((bird.y - bird.radius < p.y) || (bird.y + bird.radius > p.y + this.gap)) {
                            gameOver();
                        }
                    }

                    // Punktacja
                    if (p.x + this.w < bird.x && !p.passed) {
                        score++;
                        scoreEl.innerText = score;
                        p.passed = true;
                        
                        // Sprawd藕 wygran
                        if (score >= TARGET_SCORE) {
                            winGame();
                        }
                    }

                    // Usuwanie starych rur
                    if (p.x + this.w <= 0) {
                        this.position.shift();
                        i--; // korekta indeksu po usuniciu
                    }
                }
            }
        };

        // --- PTLA GRY ---
        function loop() {
            if (!isRunning) return;

            // To - czycimy
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Chmury w tle (ozdoba)
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.beginPath();
            ctx.arc((frames * 0.5) % (canvas.width + 100) - 50, 100, 30, 0, Math.PI*2);
            ctx.fill();

            pipes.update();
            pipes.draw();
            
            bird.update();
            bird.draw();

            frames++;
            requestAnimationFrame(loop);
        }

        // --- STEROWANIE ---
        function startGame() {
            startScreen.classList.add('hidden');
            isRunning = true;
            loop();
        }

        function resetGame() {
            bird.y = 150;
            bird.velocity = 0;
            pipes.position = [];
            score = 0;
            scoreEl.innerText = score;
            frames = 0;
            failScreen.classList.add('hidden');
            isRunning = true;
            loop();
        }

        function gameOver() {
            isRunning = false;
            failScreen.classList.remove('hidden');
        }

        function winGame() {
            isRunning = false;
            localStorage.setItem('wygrana3', 'tak');
            winScreen.classList.remove('hidden');
        }

        function finish() {
            window.location.href = 'index.html';
        }

        // Event Listeners
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') bird.flap();
        });

        // Obsuga dotyku i myszy na caym ekranie
        window.addEventListener('mousedown', () => {
            if(isRunning) bird.flap();
        });
        
        window.addEventListener('touchstart', (e) => {
            if(isRunning) {
                e.preventDefault(); // nie scrolluj
                bird.flap();
            }
        }, {passive: false});

    </script>
</body>
</html>
