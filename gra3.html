<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gra 3: Strzaa Amora</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: #fdfbf7;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: none; /* Blokada zoomowania */
        }

        /* --- INTERFEJS --- */
        .ui {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        h2 {
            font-family: 'Dancing Script', cursive;
            color: #d4af37;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .level-info {
            color: #888;
            font-size: 0.9rem;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* POKAZYWANIE ILE STRZA ZOSTAO */
        .ammo-dots {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        .dot {
            width: 10px; height: 10px;
            background: #d4af37;
            border-radius: 50%;
            opacity: 0.3;
        }
        .dot.active { opacity: 1; transform: scale(1.2); }

        canvas {
            display: block;
        }

        /* EKRANY KOCOWE */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .btn {
            background: #d4af37;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            text-decoration: none;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }
        
        .btn-retry {
            background: #ff4d4d;
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.4);
        }

        /* EFEKT BDU (Flash) */
        #flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; z-index: 50;
            transition: opacity 0.1s;
        }
    </style>
</head>
<body>

    <div class="ui">
        <h2>Traf w moje serce</h2>
        <div class="level-info">Nie traf w inne strzay!</div>
        <div class="ammo-dots" id="ammo-container"></div>
    </div>

    <div id="flash"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="win-modal" class="modal">
        <h1 style="color: #d4af37; font-family: 'Dancing Script'; font-size: 3rem;">Idealnie!</h1>
        <p>Masz cela prosto do mojego serca.</p>
        <a href="index.html" class="btn" onclick="finish()">Odbierz obraz</a>
    </div>

    <div id="fail-modal" class="modal" style="background: rgba(0,0,0,0.8);">
        <h1 style="color: white; font-family: 'Dancing Script'; font-size: 3rem;">Aa! </h1>
        <p style="color: white;">Strzay si zderzyy. Spr贸buj jeszcze raz.</p>
        <button class="btn btn-retry" onclick="resetGame()">Spr贸buj ponownie</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ammoContainer = document.getElementById('ammo-container');

        // Ustawienia
        let CW, CH;
        let centerX, centerY;
        
        // Stan gry
        let arrows = []; // Strzay wbite w serce (kty)
        let totalArrows = 8; // Ile trzeba wbi 偶eby wygra
        let arrowsLeft = totalArrows;
        let rotation = 0;
        let speed = 0.02; // Prdko obrotu
        let isDead = false;
        let flyingArrow = null; // Pozycja Y leccej strzay (jeli istnieje)
        
        // Konfiguracja wizualna
        const HEART_RADIUS = 60;
        const ARROW_LEN = 120;
        const PIN_DEPTH = 20; // Jak gboko strzaa wchodzi w serce

        // Twarz (opcjonalnie)
        const faceImg = new Image();
        faceImg.src = 'twarz.png';

        function resize() {
            CW = canvas.width = window.innerWidth;
            CH = canvas.height = window.innerHeight;
            centerX = CW / 2;
            centerY = CH / 3; // Serce jest w 1/3 wysokoci ekranu
        }
        window.addEventListener('resize', resize);
        resize();

        function updateAmmoUI() {
            ammoContainer.innerHTML = '';
            for(let i=0; i<arrowsLeft; i++) {
                const dot = document.createElement('div');
                dot.classList.add('dot', 'active');
                ammoContainer.appendChild(dot);
            }
        }

        // Rysowanie serca
        function drawHeart(x, y, r, angle) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            ctx.shadowBlur = 20;
            ctx.shadowColor = "rgba(230, 57, 70, 0.4)";
            ctx.fillStyle = "#e63946"; // Czerwony
            
            ctx.beginPath();
            // Ksztat serca matematyczny
            for (let i = 0; i < Math.PI * 2; i += 0.1) {
                let x = 16 * Math.pow(Math.sin(i), 3);
                let y = -(13 * Math.cos(i) - 5 * Math.cos(2 * i) - 2 * Math.cos(3 * i) - Math.cos(4 * i));
                // Skalowanie
                x *= (r / 16);
                y *= (r / 16);
                ctx.lineTo(x, y);
            }
            ctx.fill();

            // Rysowanie twarzy w rodku (jeli jest)
            ctx.clip(); // Przycinamy do ksztatu serca
            if (faceImg.complete && faceImg.naturalWidth !== 0) {
                // Rysujemy zdjcie
                ctx.rotate(-angle); // Kontrujemy obr贸t, 偶eby twarz bya prosto? 
                // Albo niech si krci - mieszniej. Zostawmy krcenie.
                // 呕eby twarz si krcia:
                ctx.drawImage(faceImg, -r, -r, r*2, r*2);
            } 
            
            ctx.restore();
        }

        function drawArrow(x, y, angle) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            // Trzonek
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(0, ARROW_LEN);
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 4;
            ctx.stroke();

            // Grot (kulka na kocu)
            ctx.beginPath();
            ctx.arc(0, ARROW_LEN, 6, 0, Math.PI*2);
            ctx.fillStyle = "#d4af37";
            ctx.fill();

            ctx.restore();
        }

        function loop() {
            if (isDead && flyingArrow === null) return; // Zatrzymaj ptl tylko jak przegrana i brak animacji
            requestAnimationFrame(loop);

            ctx.clearRect(0, 0, CW, CH);

            // Aktualizacja obrotu
            // Zmienna prdko dla utrudnienia
            if (!isDead) {
                rotation += speed;
                // Co jaki czas zmiana prdkoci
                if (Date.now() % 2000 < 20) {
                    speed = (Math.random() * 0.04) + 0.01; 
                    if(Math.random() > 0.5) speed *= -1; // Czasem zmie kierunek
                }
            }

            // 1. Rysuj wbite strzay
            // Wa偶ne: one krc si razem z sercem
            for (let arrowAngle of arrows) {
                // Pozycja wbicia na obwodzie koa
                // Matematyka: pozycja to rodek + wektor obr贸cony o (rotation + arrowAngle)
                const currentAngle = rotation + arrowAngle;
                
                const pinX = centerX + Math.cos(currentAngle) * (HEART_RADIUS - PIN_DEPTH);
                const pinY = centerY + Math.sin(currentAngle) * (HEART_RADIUS - PIN_DEPTH);

                // Strzaa wystaje na zewntrz, wic jej kt to currentAngle
                drawArrow(pinX, pinY, currentAngle + Math.PI/2); 
            }

            // 2. Rysuj serce na wierzchu (偶eby przykry groty strza)
            drawHeart(centerX, centerY, HEART_RADIUS, rotation);

            // 3. Rysuj strza gracza (t co leci albo czeka)
            if (flyingArrow !== null) {
                // Leci
                flyingArrow -= 25; // Szybko lotu
                drawArrow(centerX, flyingArrow, Math.PI); // Math.PI 偶eby bya skierowana w g贸r

                // Kolizja z sercem
                if (flyingArrow <= centerY + HEART_RADIUS - PIN_DEPTH) {
                    // TRAFIENIE!
                    
                    // Obliczamy kt trafienia wzgldem OBECNEGO obrotu serca
                    // Strzaa uderza od dou, czyli w kcie 90 stopni (PI/2)
                    // Ale serce jest obr贸cone o 'rotation'.
                    // Wic relatywny kt to: PI/2 - rotation
                    let hitAngle = (Math.PI / 2) - rotation;
                    
                    // Normalizacja do 0-2PI
                    hitAngle = hitAngle % (Math.PI * 2);
                    if (hitAngle < 0) hitAngle += Math.PI * 2;

                    // Sprawd藕 czy nie uderzylimy w inn strza
                    let crash = false;
                    const minDistance = 0.3; // Minimalny odstp w radianach

                    for (let existing of arrows) {
                        let diff = Math.abs(existing - hitAngle);
                        if (diff > Math.PI) diff = (Math.PI * 2) - diff; // Obsuga przejcia przez 0
                        if (diff < minDistance) {
                            crash = true;
                            break;
                        }
                    }

                    if (crash) {
                        gameOver();
                    } else {
                        // Sukces
                        arrows.push(hitAngle);
                        flyingArrow = null;
                        arrowsLeft--;
                        updateAmmoUI();

                        // Efekt wstrzsu
                        ctx.translate(Math.random()*4-2, Math.random()*4-2);

                        if (arrowsLeft <= 0) {
                            win();
                        }
                    }
                }
            } else if (!isDead && arrowsLeft > 0) {
                // Czeka na wystrza
                drawArrow(centerX, CH - 100, Math.PI);
            }
        }

        function shoot() {
            if (isDead || flyingArrow !== null || arrowsLeft <= 0) return;
            flyingArrow = CH - 100; // Startujemy lot
        }

        function gameOver() {
            isDead = true;
            document.getElementById('flash').style.opacity = 0.5;
            setTimeout(() => document.getElementById('flash').style.opacity = 0, 100);
            
            // Poka偶 ekran przegranej
            setTimeout(() => {
                document.getElementById('fail-modal').style.display = 'flex';
            }, 500);
        }

        function resetGame() {
            isDead = false;
            arrows = [];
            arrowsLeft = totalArrows;
            flyingArrow = null;
            speed = 0.02;
            updateAmmoUI();
            document.getElementById('fail-modal').style.display = 'none';
            loop(); // Restart ptli
        }

        function win() {
            isDead = true; // Zatrzymujemy strzelanie
            localStorage.setItem('wygrana3', 'tak');
            setTimeout(() => {
                document.getElementById('win-modal').style.display = 'flex';
            }, 500);
        }

        function finish() {
            window.location.href = 'index.html';
        }

        // Sterowanie
        window.addEventListener('mousedown', shoot);
        window.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Stop zoom
            shoot();
        }, {passive: false});

        // Start
        updateAmmoUI();
        loop();

    </script>
</body>
</html>
